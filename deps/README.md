# C Wrapper

Since Torch is a C++-library, a C wrapper is needed for Julia to interact with Torch.

## Generating

The C wrapper can be generated from the `Declarations.yaml`-file included with `Torch_jll`:
```sh
mkdir c_wrapper_generator/data
curl https://raw.githubusercontent.com/LaurentMazare/ocaml-torch/main/third_party/pytorch/Declarations-v1.4.0.yaml -o c_wrapper_generator/data/Declarations.yaml
```

The C wrapper can then be generated by building and running the (OCaml-based) C wrapper generator, e.g. by using the dev. container (which includes OCaml and OPAM):
```sh
cd c_wrapper_generator
opam install -y . --deps-only
opam exec -- dune build
_build/default/bin/main.exe
```
or by using an OCaml-container:
```sh
docker run -it --rm -v `pwd`:/workspace -w /workspace ocaml/opam:debian-11-ocaml-4.12 bash -c '
  cd c_wrapper_generator
  opam install -y . --deps-only
  opam exec -- dune build
  _build/default/bin/main.exe
'
```

## Building

The C wrapper can be built given that we can provide the paths to Torch, CUDA, and CUDNN. Torch can be downloaded from the [official libtorch binaries](https://pytorch.org/get-started/locally/).

### VS Code

The C wrapper can be built from VS Code, provided that CMake is configured appropriately, e.g. by ensuring the following settings are in `.vscode/settings.json` (using the dev. container - or ensuring otherwise that `$CMAKE_PREFIX_PATH` is the path to `libtorch`):

```json
{
    "cmake.buildDirectory": "${workspaceFolder}/deps/c_wrapper/build",
    "cmake.buildEnvironment": {
        "CMAKE_PREFIX_PATH": "$CMAKE_PREFIX_PATH"
    },
    "cmake.sourceDirectory": "${workspaceFolder}/deps/c_wrapper"
}
```

### Manually

The C wrapper can also be built manually, e.g.

```sh
cd c_wrapper
mkdir build && cd build

# With a working torch install via Python (or similar): setting the CMAKE_PREFIX_PATH to point there might be sufficient
CMAKE_PREFIX_PATH=$HOME/.local/lib/python3.6/site-packages/torch\
  CUDNN_LIBRARY_PATH=$HOME/cuda/lib64\
  CUDNN_INCLUDE_PATH=$HOME/cuda/include\
  CUDNN_INCLUDE_DIR=$HOME/cuda/include\ 
  cmake ..

cmake --build .
```

Post this, adding the path to the project via the `LD_LIBRARY_PATH` (and also the CUDNN) binary path might be needed.

# Julia Wrapper

The Julia wrapper is generated from the C wrapper using [Clang.jl](https://github.com/JuliaInterop/Clang.jl).

## Generating

The Julia wrapper can be generated by running:
```sh
cd julia_wrapper_generator
julia --project generator.jl
```
